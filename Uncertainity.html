<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>科学测量数据处理</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.8.0/lib/browser/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cae;
            --accent-color: #9bb0c8;
            --background-color: #f5f7fa;
            --card-color: #ffffff;
            --text-color: #333333;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        h1 {
            font-weight: 300;
            margin-bottom: 10px;
        }

        .card {
            background: var(--card-color);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
        }

        .card-title {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--accent-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        button:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .input-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-group label {
            width: 120px;
            margin-bottom: 0;
        }

        .input-group input, .input-group select {
            flex: 1;
            min-width: 0;
        }

        .input-wrapper {
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-top: 10px;
        }

        .add-btn, .remove-btn {
            margin-top: 10px;
        }

        .remove-btn {
            background: linear-gradient(135deg, #d9534f, #c9302c);
        }

        .remove-btn:hover {
            background: linear-gradient(135deg, #c9302c, #d9534f);
        }

        .data-rows {
            margin-top: 15px;
        }

        .results {
            padding: 15px;
            background: #f0f8ff;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
        }

        .instrument-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .instrument-selector .input-group {
            flex: 1;
            min-width: 250px;
        }

        .chart-container {
            height: 400px;
            margin-top: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* 单位选择器样式 */
        .unit-select {
            width: auto;
            min-width: 80px;
            margin-left: 10px;
        }

        /* 加载指示器 */
        .loading {
            text-align: center;
            padding: 20px;
        }

        .loading::after {
            content: "计算中...";
            color: var(--primary-color);
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: "计算中."; }
            40% { content: "计算中.."; }
            60%, 100% { content: "计算中..."; }
        }

        .results-container {
            margin-top: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .placeholder-message {
            text-align: center;
            padding: 30px;
            color: #888;
            font-style: italic;
            background: #f9f9f9;
            border-radius: var(--border-radius);
        }
        
        .results-summary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--box-shadow);
        }
        
        .summary-info {
            flex: 1;
        }
        
        .summary-actions {
            display: flex;
            gap: 10px;
        }
        
        .result-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-card {
            background: var(--card-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeIn 0.6s ease forwards;
            animation-delay: calc(var(--index) * 0.1s);
            opacity: 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header .symbol {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .card-header .type-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .card-body {
            padding: 15px 20px;
        }
        
        .result-row {
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .result-row:last-child {
            border-bottom: none;
        }
        
        .result-label {
            color: #666;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        
        .result-value {
            font-weight: 600;
            text-align: right;
        }
        
        .unit {
            margin-left: 3px;
            color: #777;
            font-size: 0.9em;
        }
        
        .uncertainty-bar {
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .uncertainty-fill {
            height: 100%;
            background: linear-gradient(to right, #4CAF50, #FFC107, #F44336);
            width: 0;
            border-radius: 3px;
            transition: width 1s ease;
        }
        
        .copy-btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            background: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .info-tooltip {
            position: relative;
            display: inline-flex;
            margin-left: 6px;
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            cursor: help;
        }
        
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 6px 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 12px;
            letter-spacing: 0.3px;
        }
        
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .regression-equation {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            font-size: 0.9em;
            line-height: 1.5;
        }

        /* 批量计算样式 */
        .formula-input {
            width: 60%;
            font-family: 'Courier New', monospace;
        }

        .small-btn {
            padding: 6px 12px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 8px;
        }

        .red-btn {
            background: #dc3545;
        }

        .constants-container, .variables-container, .batch-results {
            margin-top: 20px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }

        .constants-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .constant-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .constant-item input {
            width: 40%;
            margin: 0 8px;
        }

        .variables-header {
            display: flex;
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px 4px 0 0;
            font-weight: bold;
        }

        .variables-data {
            margin-bottom: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .variable-row {
            display: flex;
            background: white;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .variable-row:nth-child(even) {
            background: #f8f9fa;
        }

        .variable-cell {
            flex: 1;
            padding: 0 5px;
        }

        .variable-cell input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .batch-results-container {
            margin-top: 15px;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th, .results-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .results-table th {
            background: #e9ecef;
            font-weight: bold;
        }

        .results-summary {
            margin-top: 15px;
            padding: 10px;
            background: #049ab7;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 导入变量模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .variable-choice {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        .variable-choice input[type="checkbox"] {
            margin-right: 10px;
        }

        .variable-choice-label {
            font-weight: bold;
            margin-right: 10px;
        }

        .variable-choice-data {
            color: #666;
            font-size: 0.9em;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }

        .cell-actions {
            width: 30px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>科学测量数据处理</h1>
            <p>计算测量不确定度和进行数据分析</p>
        </header>
        
        <div class="card">
            <h2 class="card-title">直接测量量</h2>
            <p>输入每个测量量的符号、数据和仪器信息</p>
            <div id="direct-measurements">
                <!-- 这里将添加测量量组 -->
            </div>
            <button type="button" id="add-measurement-btn" class="add-btn">添加测量量</button>
        </div>
        
        <div class="card">
            <h2 class="card-title">间接测量量</h2>
            <p>使用直接测量量计算间接测量量</p>
            <div id="indirect-measurements">
                <!-- 这里将添加间接测量量 -->
            </div>
            <button type="button" id="add-indirect-btn" class="add-btn">添加间接测量量</button>
        </div>
        
        <div class="card">
            <h2 class="card-title">数据可视化</h2>
            <div class="form-group">
                <div class="input-group">
                    <label>X 轴：</label>
                    <select id="x-axis-select">
                        <option value="">选择变量</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Y 轴：</label>
                    <select id="y-axis-select">
                        <option value="">选择变量</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>线性回归：</label>
                    <input type="checkbox" id="regression-checkbox" style="width: auto;">
                </div>
                <button type="button" id="plot-btn">绘制图表</button>
            </div>
            <div class="chart-container">
                <canvas id="data-chart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h2 class="card-title">计算结果</h2>
            <button type="button" id="calculate-btn" class="add-btn">计算</button>
            <div id="results-container" class="results-container">
                <div class="placeholder-message">点击"计算"按钮查看结果</div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">批量计算</h2>
            <div class="form-group">
                <div class="input-group">
                    <label>计算公式：</label>
                    <input type="text" id="batch-formula" placeholder="例如: (v2^2-v1^2)*L/(2*S*h)" class="formula-input">
                    <button type="button" id="validate-formula-btn" class="small-btn">验证公式</button>
                </div>
                
                <div class="constants-container">
                    <h3>常量设置</h3>
                    <div class="constants-list" id="constants-list">
                        <!-- 常量将被动态添加 -->
                    </div>
                    <div class="input-group">
                        <input type="text" id="constant-name" placeholder="常量名称" style="width: 120px;">
                        <input type="number" id="constant-value" placeholder="常量值" style="width: 120px;">
                        <button type="button" id="add-constant-btn" class="small-btn">添加常量</button>
                    </div>
                </div>
                
                <div class="variables-container" style="display: none;">
                    <h3>变量数据</h3>
                    <div class="variables-header" id="variables-header">
                        <!-- 变量表头将被动态添加 -->
                    </div>
                    <div class="variables-data" id="variables-data">
                        <!-- 变量数据行将被动态添加 -->
                    </div>
                    <div class="button-group">
                        <button type="button" id="add-variable-row-btn" class="small-btn">添加数据行</button>
                        <button type="button" id="import-variable-btn" class="small-btn">导入已有变量</button>
                        <button type="button" id="clear-variables-btn" class="small-btn red-btn">清空数据</button>
                    </div>
                </div>
                
                <button type="button" id="batch-calculate-btn" class="add-btn" style="margin-top: 20px; display: none;">批量计算</button>
                
                <div class="batch-results" id="batch-results" style="display: none;">
                    <h3>计算结果</h3>
                    <div class="batch-results-container" id="batch-results-container">
                        <!-- 计算结果将显示在这里 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 单位系统定义
        const unitSystems = {
            'length': {
                'base': 'm',
                'units': {
                    'nm': 1e-9,
                    'µm': 1e-6,
                    'mm': 1e-3,
                    'cm': 1e-2,
                    'dm': 1e-1,
                    'm': 1,
                    'km': 1e3
                }
            },
            'mass': {
                'base': 'kg',
                'units': {
                    'µg': 1e-9,
                    'mg': 1e-6,
                    'g': 1e-3,
                    'kg': 1
                }
            },
            'time': {
                'base': 's',
                'units': {
                    'µs': 1e-6,
                    'ms': 1e-3,
                    's': 1,
                    'min': 60,
                    'h': 3600
                }
            },
            'current': {
                'base': 'A',
                'units': {
                    'µA': 1e-6,
                    'mA': 1e-3,
                    'A': 1
                }
            },
            'voltage': {
                'base': 'V',
                'units': {
                    'µV': 1e-6,
                    'mV': 1e-3,
                    'V': 1
                }
            },
            'temperature': {
                'base': 'K',
                'units': {
                    'K': 1,
                    '°C': { 
                        toBase: (v) => v + 273.15, 
                        fromBase: (v) => v - 273.15 
                    }
                }
            },
            'angle': {
                'base': 'rad',
                'units': {
                    'rad': 1,
                    'deg': Math.PI/180
                }
            },
            'dimensionless': {
                'base': '',
                'units': {
                    '': 1
                }
            }
        };

        // 全局图表变量
        let chart = null;

        // 单位转换函数
        function convertUnit(value, fromUnit, toUnit, quantityType) {
            if (fromUnit === toUnit) return value;
            
            const system = unitSystems[quantityType];
            if (!system) return value;  // 未知物理量类型
            
            // 获取转换因子
            const fromFactor = system.units[fromUnit];
            const toFactor = system.units[toUnit];
            
            if (!fromFactor || !toFactor) return value;  // 未知单位
            
            // 特殊处理温度等非线性单位
            if (typeof fromFactor === 'object' && typeof toFactor === 'object') {
                return toFactor.fromBase(fromFactor.toBase(value));
            } else if (typeof fromFactor === 'object') {
                return fromFactor.toBase(value) / toFactor;
            } else if (typeof toFactor === 'object') {
                return toFactor.fromBase(value * fromFactor);
            } else {
                return (value * fromFactor) / toFactor;
            }
        }

        // 填充单位选择器
        function populateUnitSelector(selector, quantityType) {
            selector.innerHTML = '';
            
            const system = unitSystems[quantityType];
            if (!system) return;
            
            // 添加单位选项
            for (const unit in system.units) {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                selector.appendChild(option);
            }
            
            // 默认选择基本单位
            for (let i = 0; i < selector.options.length; i++) {
                if (selector.options[i].value === system.base) {
                    selector.selectedIndex = i;
                    break;
                }
            }
        }

        // 添加数据行
        function addDataRow(groupId) {
            const group = document.getElementById(groupId);
            if (!group) {
                console.error('组不存在:', groupId);
                return;
            }
            
            const dataRows = group.querySelector('.data-rows');
            const rowIndex = dataRows.children.length;
            
            const row = document.createElement('div');
            row.className = 'input-group';
            
            // 获取当前物理量类型
            const quantityType = group.querySelector('.quantity-type').value;
            
            row.innerHTML = `
                <label>数据 ${rowIndex + 1}：</label>
                <input type="number" step="any" class="data-value" placeholder="输入测量值">
                <select class="data-unit unit-select">
                    <!-- 单位选项会动态填充 -->
                </select>
                ${rowIndex > 0 ? '<button type="button" class="remove-btn">x</button>' : ''}
            `;
            
            dataRows.appendChild(row);
            
            // 给"删除"按钮添加事件监听器
            const removeBtn = row.querySelector('.remove-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    removeDataRow(this);
                });
            }
            
            // 填充单位选择器
            const unitSelect = row.querySelector('.data-unit');
            populateUnitSelector(unitSelect, quantityType);
        }

        // 删除数据行
        function removeDataRow(button) {
            const row = button.closest('.input-group');
            const dataRows = row.parentElement;
            row.remove();
            
            // 重新编号
            const rows = dataRows.querySelectorAll('.input-group');
            rows.forEach((r, index) => {
                const label = r.querySelector('label');
                label.textContent = `数据 ${index + 1}：`;
            });
        }

        // 添加测量量组
        function addMeasurementGroup() {
            const container = document.getElementById('direct-measurements');
            const groupCount = container.querySelectorAll('.form-group').length;
            
            // 创建唯一ID
            const groupId = 'group-' + Date.now();
            
            const newGroup = document.createElement('div');
            newGroup.className = 'form-group';
            newGroup.id = groupId;
            
            newGroup.innerHTML = `
                <label>测量量 ${groupCount + 1}</label>
                <div class="input-wrapper">
                    <div class="input-group">
                        <label>符号：</label>
                        <input type="text" class="symbol" placeholder="例如：L">
                    </div>
                    <div class="input-group">
                        <label>物理量：</label>
                        <select class="quantity-type">
                            <option value="length">长度</option>
                            <option value="mass">质量</option>
                            <option value="time">时间</option>
                            <option value="current">电流</option>
                            <option value="voltage">电压</option>
                            <option value="temperature">温度</option>
                            <option value="angle">角度</option>
                            <option value="dimensionless">无量纲</option>
                        </select>
                    </div>
                    <div class="instrument-selector">
                        <div class="input-group">
                            <label>测量仪器：</label>
                            <select class="instrument-select">
                                <option value="custom">自定义</option>
                                <option value="ruler">直尺</option>
                                <option value="vernier">游标卡尺</option>
                                <option value="micrometer">千分尺</option>
                                <option value="scale">电子秤</option>
                                <option value="stopwatch">秒表</option>
                                <option value="multimeter">万用表</option>
                                <option value="thermometer">温度计</option>
                                <option value="protractor">量角器</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>仪器误差：</label>
                            <input type="number" step="any" class="instrument-error" value="0.5">
                            <select class="instrument-error-unit unit-select">
                                <!-- 会根据物理量类型动态填充 -->
                            </select>
                        </div>
                    </div>
                    <div class="data-rows">
                        <!-- 数据行会在这里添加 -->
                    </div>
                    <button type="button" class="add-btn">添加数据点</button>
                </div>
                <button type="button" class="remove-btn">x</button>
            `;
            
            container.appendChild(newGroup);
            
            // 为物理量类型选择器添加事件监听器
            const quantityTypeSelect = newGroup.querySelector('.quantity-type');
            quantityTypeSelect.addEventListener('change', function() {
                updateUnitSelectors(this);
            });
            
            // 为仪器选择器添加事件监听器
            const instrumentSelect = newGroup.querySelector('.instrument-select');
            instrumentSelect.addEventListener('change', function() {
                updateInstrumentError(this);
            });
            
            // 为"添加数据点"按钮添加事件监听器
            const addButton = newGroup.querySelector('.add-btn');
            addButton.addEventListener('click', function() {
                addDataRow(groupId);
            });
            
            // 为"删除测量量"按钮添加事件监听器
            const removeButton = newGroup.querySelector('.remove-btn');
            removeButton.addEventListener('click', function() {
                removeMeasurementGroup(this);
            });
            
            // 初始化单位选择器
            updateUnitSelectors(quantityTypeSelect);
            
            // 添加第一个数据行
            addDataRow(groupId);
        }

        // 删除测量量组
        function removeMeasurementGroup(button) {
            const group = button.closest('.form-group');
            group.remove();
            
            // 重新编号
            const groups = document.querySelectorAll('#direct-measurements .form-group');
            groups.forEach((g, index) => {
                g.querySelector('label').textContent = `测量量 ${index + 1}`;
            });
        }

        // 更新单位选择器
        function updateUnitSelectors(selectElement) {
            const group = selectElement.closest('.form-group');
            const quantityType = selectElement.value;
            
            // 更新仪器误差单位选择器
            const errorUnitSelect = group.querySelector('.instrument-error-unit');
            populateUnitSelector(errorUnitSelect, quantityType);
            
            // 更新所有数据单位选择器
            const unitSelectors = group.querySelectorAll('.data-unit');
            unitSelectors.forEach(selector => {
                populateUnitSelector(selector, quantityType);
            });
        }

        // 更新仪器误差
        function updateInstrumentError(selectElement) {
            const group = selectElement.closest('.form-group');
            const errorInput = group.querySelector('.instrument-error');
            const errorUnitSelect = group.querySelector('.instrument-error-unit');
            const quantityType = group.querySelector('.quantity-type').value;
            
            // 根据选择的仪器设置默认误差
            const instrumentType = selectElement.value;
            let errorValue = 0;
            let errorUnit = '';
            
            switch (instrumentType) {
                case 'ruler':
                    errorValue = 0.5;
                    errorUnit = 'mm';
                    break;
                case 'vernier':
                    errorValue = 0.02;
                    errorUnit = 'mm';
                    break;
                case 'micrometer':
                    errorValue = 0.001;
                    errorUnit = 'mm';
                    break;
                case 'scale':
                    errorValue = 0.1;
                    errorUnit = 'g';
                    break;
                case 'stopwatch':
                    errorValue = 0.1;
                    errorUnit = 's';
                    break;
                case 'multimeter':
                    errorValue = 0.01;
                    errorUnit = quantityType === 'voltage' ? 'V' : 'mA';
                    break;
                case 'thermometer':
                    errorValue = 0.5;
                    errorUnit = '°C';
                    break;
                case 'protractor':
                    errorValue = 1;
                    errorUnit = 'deg';
                    break;
                default:
                    return; // 自定义不改变现有值
            }
            
            errorInput.value = errorValue;
            
            // 选择对应的单位
            for (let i = 0; i < errorUnitSelect.options.length; i++) {
                if (errorUnitSelect.options[i].value === errorUnit) {
                    errorUnitSelect.selectedIndex = i;
                    break;
                }
            }
        }

        // 添加间接测量量
        function addIndirectMeasurement() {
            const container = document.getElementById('indirect-measurements');
            const groupCount = container.querySelectorAll('.form-group').length;
            
            const newGroup = document.createElement('div');
            newGroup.className = 'form-group';
            
            newGroup.innerHTML = `
                <label>间接测量量 ${groupCount + 1}</label>
                <div class="input-group">
                    <label>符号：</label>
                    <input type="text" class="symbol" placeholder="例如：A">
                </div>
                <div class="input-group">
                    <label>公式：</label>
                    <input type="text" class="formula" placeholder="例如：L*W（使用直接测量量的符号）">
                </div>
                <div class="input-group">
                    <label>物理量：</label>
                    <select class="quantity-type">
                        <option value="length">长度</option>
                        <option value="mass">质量</option>
                        <option value="time">时间</option>
                        <option value="current">电流</option>
                        <option value="voltage">电压</option>
                        <option value="temperature">温度</option>
                        <option value="angle">角度</option>
                        <option value="dimensionless">无量纲</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>输出单位：</label>
                    <select class="output-unit unit-select">
                        <!-- 单位会动态填充 -->
                    </select>
                </div>
                <button type="button" class="remove-btn">x</button>
            `;
            
            container.appendChild(newGroup);
            
            // 为物理量类型选择器添加事件监听器
            const quantityTypeSelect = newGroup.querySelector('.quantity-type');
            quantityTypeSelect.addEventListener('change', function() {
                updateIndirectUnitSelector(this);
            });
            
            // 为"删除"按钮添加事件监听器
            const removeButton = newGroup.querySelector('.remove-btn');
            removeButton.addEventListener('click', function() {
                removeIndirectMeasurement(this);
            });
            
            // 填充输出单位选择器
            updateIndirectUnitSelector(newGroup.querySelector('.quantity-type'));
        }

        // 更新间接测量量的单位选择器
        function updateIndirectUnitSelector(selectElement) {
            const group = selectElement.closest('.form-group');
            const quantityType = selectElement.value;
            const outputUnitSelect = group.querySelector('.output-unit');
            
            populateUnitSelector(outputUnitSelect, quantityType);
        }

        // 删除间接测量量
        function removeIndirectMeasurement(button) {
            const group = button.closest('.form-group');
            group.remove();
            
            // 重新编号
            const groups = document.querySelectorAll('#indirect-measurements .form-group');
            groups.forEach((g, index) => {
                g.querySelector('label').textContent = `间接测量量 ${index + 1}`;
            });
        }
        
        // 计算结果
        function calculateResults() {
            console.log("calculateResults 函数被调用");
            
            // 获取所有直接测量量
            const directMeasurements = [];
            const directGroups = document.querySelectorAll('#direct-measurements .form-group');
            
            directGroups.forEach(group => {
                const symbol = group.querySelector('.symbol').value.trim();
                if (!symbol) return; // 跳过没有符号的测量量
                
                const quantityType = group.querySelector('.quantity-type').value;
                const instrumentError = parseFloat(group.querySelector('.instrument-error').value);
                const instrumentErrorUnit = group.querySelector('.instrument-error-unit').value;
                
                // 获取所有数据点
                const dataPoints = [];
                const dataRows = group.querySelectorAll('.data-rows .input-group');
                let dataUnit = '';
                
                dataRows.forEach(row => {
                    const dataValue = parseFloat(row.querySelector('.data-value').value);
                    if (!isNaN(dataValue)) {
                        dataPoints.push(dataValue);
                        dataUnit = row.querySelector('.data-unit').value;
                    }
                });
                
                if (dataPoints.length === 0) return; // 跳过没有数据的测量量
                
                // 将仪器误差转换为与数据相同的单位
                const convertedError = convertUnit(instrumentError, instrumentErrorUnit, dataUnit);
                
                // 计算统计量
                const mean = dataPoints.reduce((sum, value) => sum + value, 0) / dataPoints.length;
                const sumSquaredDiff = dataPoints.reduce((sum, value) => sum + Math.pow(value - mean, 2), 0);
                const standardDeviation = Math.sqrt(sumSquaredDiff / (dataPoints.length - 1));
                const typeAUncertainty = standardDeviation / Math.sqrt(dataPoints.length);
                const typeBUncertainty = convertedError / Math.sqrt(3);
                const uncertainty = Math.sqrt(Math.pow(typeAUncertainty, 2) + Math.pow(typeBUncertainty, 2));
                const relativeUncertainty = Math.abs(uncertainty / mean);
                
                // 添加到直接测量量列表
                directMeasurements.push({
                    type: 'direct',
                    symbol,
                    quantityType,
                    dataCount: dataPoints.length,
                    mean,
                    standardDeviation,
                    typeAUncertainty,
                    typeBUncertainty,
                    uncertainty,
                    relativeUncertainty,
                    unit: dataUnit,
                    dataPoints
                });
            });
            
            // 获取所有间接测量量
            const indirectMeasurements = [];
            const indirectGroups = document.querySelectorAll('#indirect-measurements .form-group');
            
            indirectGroups.forEach(group => {
                const symbol = group.querySelector('.symbol').value.trim();
                if (!symbol) return; // 跳过没有符号的测量量
                
                const formula = group.querySelector('.formula').value.trim();
                if (!formula) return; // 跳过没有公式的测量量
                
                const unit = group.querySelector('.output-unit').value;
                
                try {
                    // 创建包含所有直接测量量的作用域
                    const scope = {};
                    directMeasurements.forEach(m => {
                        scope[m.symbol] = m.mean;
                    });
                    
                    // 计算间接测量量的值
                    const value = math.evaluate(formula, scope);
                    
                    // 计算不确定度传递
                    let uncertaintySquareSum = 0;
                    directMeasurements.forEach(m => {
                        // 对每个变量计算偏导数
                        const symb = m.symbol;
                        const h = m.mean * 0.0001; // 小增量
                        scope[symb] = m.mean + h;
                        const fPlus = math.evaluate(formula, scope);
                        scope[symb] = m.mean - h;
                        const fMinus = math.evaluate(formula, scope);
                        scope[symb] = m.mean; // 恢复原值
                        
                        // 中心差分近似偏导数
                        const partialDerivative = (fPlus - fMinus) / (2 * h);
                        
                        // 加入不确定度平方和
                        uncertaintySquareSum += Math.pow(partialDerivative * m.uncertainty, 2);
                    });
                    
                    // 合成不确定度
                    const uncertainty = Math.sqrt(uncertaintySquareSum);
                    const relativeUncertainty = Math.abs(uncertainty / value);
                    
                    // 添加到间接测量量列表
                    indirectMeasurements.push({
                        type: 'indirect',
                        symbol,
                        formula,
                        value,
                        uncertainty,
                        relativeUncertainty,
                        unit
                    });
                } catch (error) {
                    console.error(`计算 ${symbol} 时出错:`, error);
                    alert(`计算 ${symbol} 时出错: ${error.message}`);
                }
            });
            
            // 显示结果
            displayResults(directMeasurements, indirectMeasurements);
        }
        
        // 显示计算结果
        function displayResults(directMeasurements, indirectMeasurements) {
            console.log("displayResults 函数被调用");
            console.log("直接测量量:", directMeasurements);
            console.log("间接测量量:", indirectMeasurements);
            
            const resultsContainer = document.getElementById('results-container');
            
            // 清空之前的结果
            resultsContainer.innerHTML = '';
            
            // 检查是否有计算结果
            if (directMeasurements.length === 0 && indirectMeasurements.length === 0) {
                resultsContainer.innerHTML = '<div class="placeholder-message">没有有效的测量数据</div>';
                return;
            }
            
            // 创建结果摘要
            const totalCount = directMeasurements.length + indirectMeasurements.length;
            const summaryElement = document.createElement('div');
            summaryElement.className = 'results-summary';
            summaryElement.innerHTML = `
                <div class="summary-info">
                    <h3>计算完成</h3>
                    <p>共处理了 ${directMeasurements.length} 个直接测量量和 ${indirectMeasurements.length} 个间接测量量</p>
                </div>
                <button class="copy-btn" onclick="copyResultsToClipboard()">
                    复制结果
                </button>
            `;
            resultsContainer.appendChild(summaryElement);
            
            // 创建卡片容器
            const cardsContainer = document.createElement('div');
            cardsContainer.className = 'result-cards';
            resultsContainer.appendChild(cardsContainer);
            
            // 添加直接测量量卡片
            directMeasurements.forEach((measurement, index) => {
                const card = createMeasurementCard(measurement, index);
                cardsContainer.appendChild(card);
            });
            
            // 添加间接测量量卡片
            indirectMeasurements.forEach((measurement, index) => {
                const card = createMeasurementCard(measurement, directMeasurements.length + index);
                cardsContainer.appendChild(card);
            });
            
            // 显示不确定度条
            setTimeout(() => {
                document.querySelectorAll('.uncertainty-fill').forEach(bar => {
                    bar.style.width = bar.getAttribute('data-width');
                });
            }, 100);
        }
        
        // 创建测量结果卡片
        function createMeasurementCard(measurement, index) {
            const card = document.createElement('div');
            card.className = 'result-card';
            card.style.setProperty('--index', index);
            
            const isDirect = measurement.type === 'direct';
            const relUncertaintyPercent = (measurement.relativeUncertainty * 100).toFixed(2);
            const uncertaintyBarWidth = Math.min(relUncertaintyPercent * 3, 100) + '%'; // 最大100%宽度
            
            let headerContent = `
                <div class="symbol">${measurement.symbol}</div>
                <div class="type-badge">${isDirect ? '直接测量量' : '间接测量量'}</div>
            `;
            
            let bodyContent = `
                ${isDirect ? `
                    <div class="result-row">
                        <div class="result-label">平均值</div>
                        <div class="result-value">
                            ${measurement.mean.toFixed(6)}<span class="unit">${measurement.unit}</span>
                        </div>
                    </div>
                ` : `
                    <div class="result-row">
                        <div class="result-label">计算公式</div>
                        <div class="result-value">${measurement.formula}</div>
                    </div>
                    <div class="result-row">
                        <div class="result-label">计算结果</div>
                        <div class="result-value">
                            ${measurement.value.toFixed(6)}<span class="unit">${measurement.unit}</span>
                        </div>
                    </div>
                `}
                
                <div class="result-row">
                    <div class="result-label">
                        不确定度
                        <span class="info-tooltip">?
                            <span class="tooltip-text">测量结果的不确定度表示对真值的估计范围</span>
                        </span>
                    </div>
                    <div class="result-value">
                        ±${measurement.uncertainty.toFixed(6)}<span class="unit">${measurement.unit}</span>
                    </div>
                </div>
                
                <div class="result-row">
                    <div class="result-label">
                        相对不确定度
                        <span class="info-tooltip">?
                            <span class="tooltip-text">不确定度占测量值的百分比</span>
                        </span>
                    </div>
                    <div class="result-value">${relUncertaintyPercent}%</div>
                </div>
                
                <div class="uncertainty-bar">
                    <div class="uncertainty-fill" data-width="${uncertaintyBarWidth}"></div>
                </div>
            `;
            
            // 直接测量量显示更多统计信息
            if (isDirect) {
                bodyContent += `
                    <div class="result-row">
                        <div class="result-label">测量次数</div>
                        <div class="result-value">${measurement.dataCount}</div>
                    </div>
                    
                    <div class="result-row">
                        <div class="result-label">
                            标准差
                            <span class="info-tooltip">?
                                <span class="tooltip-text">数据分散程度的度量</span>
                            </span>
                        </div>
                        <div class="result-value">
                            ${measurement.standardDeviation.toFixed(6)}<span class="unit">${measurement.unit}</span>
                        </div>
                    </div>
                    
                    <div class="result-row">
                        <div class="result-label">
                            A类不确定度
                            <span class="info-tooltip">?
                                <span class="tooltip-text">由统计分析得到的不确定度</span>
                            </span>
                        </div>
                        <div class="result-value">
                            ${measurement.typeAUncertainty.toFixed(6)}<span class="unit">${measurement.unit}</span>
                        </div>
                    </div>
                    
                    <div class="result-row">
                        <div class="result-label">
                            B类不确定度
                            <span class="info-tooltip">?
                                <span class="tooltip-text">由仪器误差等非统计因素导致的不确定度</span>
                            </span>
                        </div>
                        <div class="result-value">
                            ${measurement.typeBUncertainty.toFixed(6)}<span class="unit">${measurement.unit}</span>
                        </div>
                    </div>
                `;
            }
            
            // 组装卡片
            card.innerHTML = `
                <div class="card-header">
                    ${headerContent}
                </div>
                <div class="card-body">
                    ${bodyContent}
                </div>
            `;
            
            return card;
        }
        
        // 复制结果到剪贴板
        function copyResultsToClipboard() {
            const resultsContainer = document.getElementById('results-container');
            let resultText = '科学测量数据处理结果\n\n';
            
            // 提取结果卡片信息
            const cards = resultsContainer.querySelectorAll('.result-card');
            cards.forEach(card => {
                const symbol = card.querySelector('.symbol').textContent;
                const type = card.querySelector('.type-badge').textContent;
                
                resultText += `${symbol} (${type})\n`;
                
                // 提取每行数据
                const rows = card.querySelectorAll('.result-row');
                rows.forEach(row => {
                    const label = row.querySelector('.result-label').textContent.trim().replace(/\?/g, '');
                    const value = row.querySelector('.result-value').textContent.trim();
                    resultText += `  ${label}: ${value}\n`;
                });
                
                resultText += '\n';
            });
            
            // 复制到剪贴板
            navigator.clipboard.writeText(resultText)
                .then(() => {
                    alert('结果已复制到剪贴板');
                })
                .catch(err => {
                    console.error('复制失败:', err);
                    alert('复制失败: ' + err);
                });
        }
        
        // 更新坐标轴选择器和对应的单位选择器
        function updateAxisSelectors() {
            console.log("更新坐标轴选择器和单位");
            
            const xAxisSelect = document.getElementById('x-axis-select');
            const yAxisSelect = document.getElementById('y-axis-select');
            const xAxisUnit = document.getElementById('x-axis-unit');
            const yAxisUnit = document.getElementById('y-axis-unit');
            
            // 保存之前的选择
            const prevXValue = xAxisSelect.value;
            const prevYValue = yAxisSelect.value;
            const prevXUnit = xAxisUnit.value;
            const prevYUnit = yAxisUnit.value;
            
            // 清空当前选项
            xAxisSelect.innerHTML = '<option value="">选择变量</option>';
            yAxisSelect.innerHTML = '<option value="">选择变量</option>';
            
            // 添加所有直接测量量和间接测量量
            [...window.measurementData.direct, ...window.measurementData.indirect].forEach(measurement => {
                const xOption = document.createElement('option');
                xOption.value = measurement.symbol;
                xOption.textContent = measurement.symbol;
                xAxisSelect.appendChild(xOption);
                
                const yOption = document.createElement('option');
                yOption.value = measurement.symbol;
                yOption.textContent = measurement.symbol;
                yAxisSelect.appendChild(yOption);
            });
            
            // 恢复之前的选择
            if (prevXValue && xAxisSelect.querySelector(`option[value="${prevXValue}"]`)) {
                xAxisSelect.value = prevXValue;
            }
            
            if (prevYValue && yAxisSelect.querySelector(`option[value="${prevYValue}"]`)) {
                yAxisSelect.value = prevYValue;
            }
            
            // 更新单位选择器
            updateUnitSelector(xAxisSelect.value, xAxisUnit, prevXUnit);
            updateUnitSelector(yAxisSelect.value, yAxisUnit, prevYUnit);
            
            // 添加变更事件
            xAxisSelect.onchange = function() {
                updateUnitSelector(this.value, xAxisUnit);
            };
            
            yAxisSelect.onchange = function() {
                updateUnitSelector(this.value, yAxisUnit);
            };
        }

        // 更新单位选择器
        function updateUnitSelector(symbol, unitSelect, prevUnit = null) {
            // 清空当前选项
            unitSelect.innerHTML = '<option value="">选择单位</option>';
            
            if (!symbol) return;
            
            // 查找对应的测量量
            const measurement = [...window.measurementData.direct, ...window.measurementData.indirect]
                .find(m => m.symbol === symbol);
            
            if (!measurement) return;
            
            // 获取物理量类型
            const quantityType = measurement.type === 'direct' ? 
                measurement.quantityType : 
                getQuantityTypeFromUnit(measurement.unit);
            
            // 填充单位选择器
            populateUnitSelector(unitSelect, quantityType);
            
            // 如果有原单位，尝试设置回原单位
            if (prevUnit && unitSelect.querySelector(`option[value="${prevUnit}"]`)) {
                unitSelect.value = prevUnit;
            } else {
                // 否则设置为测量量自己的单位
                unitSelect.value = measurement.unit;
            }
        }

        // 获取单位对应的物理量类型
        function getQuantityTypeFromUnit(unit) {
            const unitMap = {
                // 长度单位
                'm': 'length', 'km': 'length', 'cm': 'length', 'mm': 'length', 'µm': 'length', 'nm': 'length',
                // 质量单位
                'kg': 'mass', 'g': 'mass', 'mg': 'mass', 'µg': 'mass',
                // 时间单位
                's': 'time', 'min': 'time', 'h': 'time', 'ms': 'time', 'µs': 'time',
                // 温度单位
                '°C': 'temperature', 'K': 'temperature',
                // 电流单位
                'A': 'current', 'mA': 'current', 'µA': 'current',
                // 电压单位
                'V': 'voltage', 'mV': 'voltage', 'µV': 'voltage', 'kV': 'voltage',
                // 角度单位
                'rad': 'angle', 'deg': 'angle',
                // 频率单位
                'Hz': 'frequency', 'kHz': 'frequency', 'MHz': 'frequency', 'GHz': 'frequency'
            };
            
            return unitMap[unit] || 'other';
        }

        // 完全重写绘图功能
        document.addEventListener('DOMContentLoaded', function() {
            console.log("初始化绘图功能");
            
            // 1. 为计算按钮添加更新绘图选择器的功能
            const calculateBtn = document.getElementById('calculate-btn');
            const originalCalculateBtnClick = calculateBtn.onclick;
            
            calculateBtn.onclick = function(e) {
                // 保留原有功能
                if (typeof originalCalculateBtnClick === 'function') {
                    originalCalculateBtnClick.call(this, e);
                } else {
                    calculateResults(); // 如果没有绑定函数，直接调用计算函数
                }
                
                // 添加更新绘图选择器的功能
                setTimeout(function() {
                    updatePlotSelectors();
                }, 200); // 稍微延迟以确保结果已计算完毕
            };
            
            // 2. 为绘图按钮添加事件
            const plotBtn = document.getElementById('plot-btn');
            plotBtn.addEventListener('click', function() {
                plotDataFromDOM();
            });
            
            // 3. 初始化绘图选择器
            updatePlotSelectors();
        });

        // 更新绘图选择器
        function updatePlotSelectors() {
            console.log("更新绘图选择器");
            const xSelect = document.getElementById('x-axis-select');
            const ySelect = document.getElementById('y-axis-select');
            
            // 清空现有选项
            xSelect.innerHTML = '<option value="">选择变量</option>';
            ySelect.innerHTML = '<option value="">选择变量</option>';
            
            // 获取所有测量量的符号
            const symbols = [];
            
            // 从所有已计算的结果卡片中获取符号
            const resultCards = document.querySelectorAll('.result-card');
            resultCards.forEach(card => {
                const symbol = card.querySelector('.symbol').textContent.trim();
                if (symbol && !symbols.includes(symbol)) {
                    symbols.push(symbol);
                }
            });
            
            // 如果没有找到已计算的结果，从表单中获取
            if (symbols.length === 0) {
                // 获取直接测量量
                const directGroups = document.querySelectorAll('#direct-measurements .form-group');
                directGroups.forEach(group => {
                    const symbol = group.querySelector('.symbol').value.trim();
                    if (symbol && !symbols.includes(symbol)) {
                        symbols.push(symbol);
                    }
                });
                
                // 获取间接测量量
                const indirectGroups = document.querySelectorAll('#indirect-measurements .form-group');
                indirectGroups.forEach(group => {
                    const symbol = group.querySelector('.symbol').value.trim();
                    if (symbol && !symbols.includes(symbol)) {
                        symbols.push(symbol);
                    }
                });
            }
            
            console.log("找到的变量:", symbols);
            
            // 添加符号到选择器
            symbols.forEach(symbol => {
                const xOption = document.createElement('option');
                xOption.value = symbol;
                xOption.textContent = symbol;
                xSelect.appendChild(xOption);
                
                const yOption = document.createElement('option');
                yOption.value = symbol;
                yOption.textContent = symbol;
                ySelect.appendChild(yOption);
            });
        }

        // 从DOM中获取数据并绘图
        function plotDataFromDOM() {
            console.log("开始绘图...");
            
            const xSymbol = document.getElementById('x-axis-select').value;
            const ySymbol = document.getElementById('y-axis-select').value;
            const useRegression = document.getElementById('regression-checkbox').checked;
            
            if (!xSymbol || !ySymbol) {
                alert('请选择X轴和Y轴变量');
                return;
            }
            
            console.log(`绘制 ${ySymbol} vs ${xSymbol}`);
            
            // 获取数据点
            const xData = getDataPointsForSymbol(xSymbol);
            const yData = getDataPointsForSymbol(ySymbol);
            
            // 确保数据长度一致
            const minLength = Math.min(xData.length, yData.length);
            const plotX = xData.slice(0, minLength);
            const plotY = yData.slice(0, minLength);
            
            console.log("数据点数:", plotX.length);
            
            if (plotX.length === 0) {
                alert('没有找到有效的数据点');
                return;
            }
            
            // 绘制图表
            drawChart(plotX, plotY, xSymbol, ySymbol, useRegression);
        }

        // 获取指定符号的数据点
        function getDataPointsForSymbol(symbol) {
            // 尝试从结果卡片获取数据
            const resultCard = Array.from(document.querySelectorAll('.result-card')).find(
                card => card.querySelector('.symbol').textContent.trim() === symbol
            );
            
            if (resultCard) {
                // 从结果卡片获取数值
                const valueText = resultCard.querySelector('.result-row:first-child .result-value').textContent;
                const value = parseFloat(valueText);
                if (!isNaN(value)) {
                    // 为了绘图，至少需要多个点，所以创建一个包含相同值的数组
                    return [value-0.1, value, value+0.1]; // 创建三个点以便绘图
                }
            }
            
            // 如果未找到结果卡片，尝试从表单中获取数据
            const directGroups = document.querySelectorAll('#direct-measurements .form-group');
            for (const group of directGroups) {
                if (group.querySelector('.symbol').value.trim() === symbol) {
                    const dataPoints = [];
                    const rows = group.querySelectorAll('.data-rows .input-group');
                    
                    rows.forEach(row => {
                        const value = parseFloat(row.querySelector('.data-value').value);
                        if (!isNaN(value)) {
                            dataPoints.push(value);
                        }
                    });
                    
                    return dataPoints;
                }
            }
            
            // 如果是间接测量量，尝试从结果显示区域获取
            const resultsContainer = document.getElementById('results-container');
            if (resultsContainer) {
                const resultText = resultsContainer.textContent;
                const regex = new RegExp(`${symbol}\\s*=\\s*([\\d.]+)`, 'i');
                const match = resultText.match(regex);
                
                if (match && match[1]) {
                    const value = parseFloat(match[1]);
                    if (!isNaN(value)) {
                        return [value-0.1, value, value+0.1]; // 同样创建三个点
                    }
                }
            }
            
            // 最后尝试从间接测量量表单中获取公式并计算
            const indirectGroups = document.querySelectorAll('#indirect-measurements .form-group');
            for (const group of indirectGroups) {
                if (group.querySelector('.symbol').value.trim() === symbol) {
                    // 计算这个间接测量量的值需要实现公式计算，这里简化处理
                    return [1, 2, 3]; // 简单返回默认值
                }
            }
            
            // 如果都没找到，返回空数组
            return [];
        }

        // 绘制图表
        function drawChart(xData, yData, xSymbol, ySymbol, useRegression) {
            const canvas = document.getElementById('data-chart');
            const ctx = canvas.getContext('2d');
            
            // 如果已存在图表，先销毁
            if (window.dataChart instanceof Chart) {
                window.dataChart.destroy();
            }
            
            // 为Chart.js准备数据
            const scatterData = xData.map((x, i) => ({ x, y: yData[i] }));
            
            // 准备数据集
            const datasets = [{
                label: '数据点',
                data: scatterData,
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                pointRadius: 5,
                pointHoverRadius: 7
            }];
            
            // 计算线性回归
            if (useRegression && xData.length > 1) {
                const { slope, intercept, r2 } = calculateLinearRegression(xData, yData);
                const minX = Math.min(...xData);
                const maxX = Math.max(...xData);
                
                // 添加回归线
                datasets.push({
                    label: `线性拟合 (R² = ${r2.toFixed(4)})`,
                    data: [
                        { x: minX, y: slope * minX + intercept },
                        { x: maxX, y: slope * maxX + intercept }
                    ],
                    type: 'line',
                    fill: false,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    pointRadius: 0
                });
                
                // 显示回归方程
                let equationDiv = canvas.parentElement.querySelector('.regression-equation');
                if (!equationDiv) {
                    equationDiv = document.createElement('div');
                    equationDiv.className = 'regression-equation';
                    canvas.parentElement.appendChild(equationDiv);
                }
                
                equationDiv.innerHTML = `
                    <strong>回归方程:</strong> ${ySymbol} = ${slope.toFixed(4)} × ${xSymbol} + ${intercept.toFixed(4)}
                    <br>
                    <strong>决定系数:</strong> R² = ${r2.toFixed(4)}
                `;
            } else {
                // 如果不使用回归，移除回归方程
                const equationDiv = canvas.parentElement.querySelector('.regression-equation');
                if (equationDiv) {
                    equationDiv.remove();
                }
            }
            
            // 创建图表
            window.dataChart = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: xSymbol
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: ySymbol
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return `(${point.x.toFixed(4)}, ${point.y.toFixed(4)})`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `${ySymbol} vs ${xSymbol}`
                        }
                    }
                }
            });
        }

        // 计算线性回归
        function calculateLinearRegression(x, y) {
            const n = x.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            
            for (let i = 0; i < n; i++) {
                sumX += x[i];
                sumY += y[i];
                sumXY += x[i] * y[i];
                sumX2 += x[i] * x[i];
            }
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            // 计算R²
            const meanY = sumY / n;
            let ssTotal = 0, ssResidual = 0;
            
            for (let i = 0; i < n; i++) {
                const yPred = slope * x[i] + intercept;
                ssTotal += Math.pow(y[i] - meanY, 2);
                ssResidual += Math.pow(y[i] - yPred, 2);
            }
            
            const r2 = 1 - (ssResidual / ssTotal);
            
            return { slope, intercept, r2 };
        }

        // 初始化
        function init() {
            // 添加第一个测量量组
            addMeasurementGroup();
            
            // 添加第一个间接测量量
            addIndirectMeasurement();
            
            // 添加事件监听器
            document.getElementById('add-measurement-btn').addEventListener('click', addMeasurementGroup);
            document.getElementById('add-indirect-btn').addEventListener('click', addIndirectMeasurement);
            document.getElementById('calculate-btn').addEventListener('click', calculateResults);
            document.getElementById('plot-btn').addEventListener('click', plotDataFromDOM);
        }

        // 页面加载完成后初始化
        window.onload = init;

        // 批量计算功能
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const batchFormulaInput = document.getElementById('batch-formula');
            const validateFormulaBtn = document.getElementById('validate-formula-btn');
            const constantsList = document.getElementById('constants-list');
            const constantNameInput = document.getElementById('constant-name');
            const constantValueInput = document.getElementById('constant-value');
            const addConstantBtn = document.getElementById('add-constant-btn');
            const variablesContainer = document.querySelector('.variables-container');
            const variablesHeader = document.getElementById('variables-header');
            const variablesData = document.getElementById('variables-data');
            const addVariableRowBtn = document.getElementById('add-variable-row-btn');
            const importVariableBtn = document.getElementById('import-variable-btn');
            const clearVariablesBtn = document.getElementById('clear-variables-btn');
            const batchCalculateBtn = document.getElementById('batch-calculate-btn');
            const batchResults = document.getElementById('batch-results');
            const batchResultsContainer = document.getElementById('batch-results-container');
            
            // 存储常量和变量
            let constants = {};
            let variables = [];
            let formula = '';
            
            // 为验证公式按钮添加事件
            validateFormulaBtn.addEventListener('click', function() {
                formula = batchFormulaInput.value.trim();
                if (!formula) {
                    alert('请输入计算公式');
                    return;
                }
                
                // 解析公式中的变量
                const symbols = extractSymbolsFromFormula(formula);
                
                // 过滤掉已设置为常量的符号
                variables = symbols.filter(symbol => !constants[symbol]);
                
                // 显示变量数据区域
                setupVariablesTable();
                variablesContainer.style.display = 'block';
                batchCalculateBtn.style.display = 'block';
                
                alert(`公式已验证，识别到变量：${variables.join(', ')}`);
            });
            
            // 提取公式中的变量和常量
            function extractSymbolsFromFormula(formula) {
                // 移除所有数学运算符、数字和空格
                const cleaned = formula.replace(/[\d\s\+\-\*\/\(\)\^\.,]/g, ' ');
                
                // 按空格分割并过滤空字符串
                const symbols = cleaned.split(' ').filter(s => s.length > 0);
                
                // 去重
                return [...new Set(symbols)];
            }
            
            // 为添加常量按钮添加事件
            addConstantBtn.addEventListener('click', function() {
                const name = constantNameInput.value.trim();
                const value = parseFloat(constantValueInput.value);
                
                if (!name) {
                    alert('请输入常量名称');
                    return;
                }
                
                if (isNaN(value)) {
                    alert('请输入有效的常量值');
                    return;
                }
                
                // 存储常量
                constants[name] = value;
                
                // 更新常量列表UI
                updateConstantsList();
                
                // 清空输入框
                constantNameInput.value = '';
                constantValueInput.value = '';
                
                // 如果公式已验证，更新变量列表（排除新添加的常量）
                if (formula) {
                    variables = variables.filter(v => v !== name);
                    setupVariablesTable();
                }
            });
            
            // 更新常量列表UI
            function updateConstantsList() {
                constantsList.innerHTML = '';
                
                for (const [name, value] of Object.entries(constants)) {
                    const constantItem = document.createElement('div');
                    constantItem.className = 'constant-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = name + ' = ';
                    constantItem.appendChild(nameSpan);
                    
                    const valueInput = document.createElement('input');
                    valueInput.type = 'number';
                    valueInput.value = value;
                    valueInput.addEventListener('change', function() {
                        constants[name] = parseFloat(this.value);
                    });
                    constantItem.appendChild(valueInput);
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '×';
                    removeBtn.className = 'remove-btn';
                    removeBtn.addEventListener('click', function() {
                        delete constants[name];
                        updateConstantsList();
                        
                        // 公式已验证，需要重新检查是否该符号应该添加回变量列表
                        if (formula) {
                            const symbols = extractSymbolsFromFormula(formula);
                            if (symbols.includes(name) && !variables.includes(name)) {
                                variables.push(name);
                                setupVariablesTable();
                            }
                        }
                    });
                    constantItem.appendChild(removeBtn);
                    
                    constantsList.appendChild(constantItem);
                }
            }
            
            // 设置变量表格
            function setupVariablesTable() {
                // 设置表头
                variablesHeader.innerHTML = '';
                
                const indexHeader = document.createElement('div');
                indexHeader.className = 'variable-cell';
                indexHeader.style.width = '40px';
                indexHeader.textContent = '序号';
                variablesHeader.appendChild(indexHeader);
                
                variables.forEach(variable => {
                    const header = document.createElement('div');
                    header.className = 'variable-cell';
                    header.textContent = variable;
                    variablesHeader.appendChild(header);
                });
                
                const actionsHeader = document.createElement('div');
                actionsHeader.className = 'cell-actions';
                actionsHeader.textContent = '';
                variablesHeader.appendChild(actionsHeader);
                
                // 清空已有数据行
                variablesData.innerHTML = '';
                
                // 添加一行空数据
                addVariableRow();
            }
            
            // 添加变量数据行
            function addVariableRow() {
                const rowIndex = variablesData.children.length + 1;
                
                const row = document.createElement('div');
                row.className = 'variable-row';
                
                const indexCell = document.createElement('div');
                indexCell.className = 'variable-cell';
                indexCell.style.width = '40px';
                indexCell.textContent = rowIndex;
                row.appendChild(indexCell);
                
                variables.forEach(variable => {
                    const cell = document.createElement('div');
                    cell.className = 'variable-cell';
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = 'any';
                    input.dataset.variable = variable;
                    cell.appendChild(input);
                    
                    row.appendChild(cell);
                });
                
                const actionsCell = document.createElement('div');
                actionsCell.className = 'cell-actions';
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '×';
                removeBtn.className = 'remove-btn';
                removeBtn.addEventListener('click', function() {
                    row.remove();
                    // 更新所有行的序号
                    updateRowIndices();
                });
                actionsCell.appendChild(removeBtn);
                
                row.appendChild(actionsCell);
                
                variablesData.appendChild(row);
            }
            
            // 更新行序号
            function updateRowIndices() {
                const rows = variablesData.querySelectorAll('.variable-row');
                rows.forEach((row, index) => {
                    const indexCell = row.querySelector('.variable-cell:first-child');
                    indexCell.textContent = index + 1;
                });
            }
            
            // 为添加数据行按钮添加事件
            addVariableRowBtn.addEventListener('click', function() {
                addVariableRow();
            });
            
            // 为清空数据按钮添加事件
            clearVariablesBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有数据行吗？')) {
                    variablesData.innerHTML = '';
                    addVariableRow(); // 添加一个空行
                }
            });
            
            // 为导入变量按钮添加事件
            importVariableBtn.addEventListener('click', function() {
                showImportVariableModal();
            });
            
            // 显示导入变量模态框
            function showImportVariableModal() {
                // 创建模态框
                let modal = document.getElementById('import-variable-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'import-variable-modal';
                    modal.className = 'modal';
                    
                    document.body.appendChild(modal);
                }
                
                // 获取已有结果中的变量
                const existingVariables = findExistingVariables();
                
                // 如果没有找到变量
                if (Object.keys(existingVariables).length === 0) {
                    alert('没有找到可导入的变量，请先计算一些结果');
                    return;
                }
                
                // 创建模态框内容
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>导入已有变量</h3>
                            <span class="modal-close">&times;</span>
                        </div>
                        <div id="variable-choices">
                            ${createVariableChoicesHTML(existingVariables)}
                        </div>
                        <div class="modal-footer">
                            <button id="import-selected-btn" class="small-btn">导入选中项</button>
                        </div>
                    </div>
                `;
                
                // 显示模态框
                modal.style.display = 'block';
                
                // 关闭模态框
                modal.querySelector('.modal-close').addEventListener('click', function() {
                    modal.style.display = 'none';
                });
                
                // 导入选中的变量
                modal.querySelector('#import-selected-btn').addEventListener('click', function() {
                    const selectedVariables = {};
                    
                    // 获取所有选中的变量
                    const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
                    checkboxes.forEach(checkbox => {
                        const symbol = checkbox.value;
                        const values = JSON.parse(checkbox.dataset.values);
                        selectedVariables[symbol] = values;
                    });
                    
                    // 导入变量
                    importSelectedVariables(selectedVariables);
                    
                    // 关闭模态框
                    modal.style.display = 'none';
                });
            }
            
            // 查找页面中已有的变量
            function findExistingVariables() {
                const existingVariables = {};
                
                // 从结果卡片中获取变量
                const resultCards = document.querySelectorAll('.result-card');
                resultCards.forEach(card => {
                    const symbol = card.querySelector('.symbol').textContent.trim();
                    const valueText = card.querySelector('.result-row:first-child .result-value').textContent;
                    const numericValue = parseFloat(valueText);
                    
                    if (!isNaN(numericValue) && variables.includes(symbol)) {
                        existingVariables[symbol] = [numericValue];
                    }
                });
                
                // 从直接测量量中获取变量
                const directGroups = document.querySelectorAll('#direct-measurements .form-group');
                directGroups.forEach(group => {
                    const symbol = group.querySelector('.symbol').value.trim();
                    if (variables.includes(symbol)) {
                        const values = [];
                        const dataRows = group.querySelectorAll('.data-rows .input-group');
                        
                        dataRows.forEach(row => {
                            const value = parseFloat(row.querySelector('.data-value').value);
                            if (!isNaN(value)) {
                                values.push(value);
                            }
                        });
                        
                        if (values.length > 0) {
                            existingVariables[symbol] = values;
                        }
                    }
                });
                
                return existingVariables;
            }
            
            // 创建变量选择项HTML
            function createVariableChoicesHTML(existingVariables) {
                let html = '';
                
                for (const [symbol, values] of Object.entries(existingVariables)) {
                    const valuesJSON = JSON.stringify(values);
                    
                    html += `
                        <div class="variable-choice">
                            <input type="checkbox" id="var-${symbol}" value="${symbol}" data-values='${valuesJSON}'>
                            <label for="var-${symbol}">
                                <span class="variable-choice-label">${symbol}</span>
                                <span class="variable-choice-data">[${values.join(', ')}]</span>
                            </label>
                        </div>
                    `;
                }
                
                return html;
            }
            
            // 导入选中的变量
            function importSelectedVariables(selectedVariables) {
                // 清空现有数据行
                variablesData.innerHTML = '';
                
                // 确定需要创建的行数
                let maxRowCount = 0;
                for (const values of Object.values(selectedVariables)) {
                    maxRowCount = Math.max(maxRowCount, values.length);
                }
                
                // 创建数据行
                for (let i = 0; i < maxRowCount; i++) {
                    addVariableRow();
                }
                
                // 填充数据
                const rows = variablesData.querySelectorAll('.variable-row');
                rows.forEach((row, rowIndex) => {
                    const inputs = row.querySelectorAll('input[data-variable]');
                    
                    inputs.forEach(input => {
                        const variable = input.dataset.variable;
                        if (selectedVariables[variable] && rowIndex < selectedVariables[variable].length) {
                            input.value = selectedVariables[variable][rowIndex];
                        }
                    });
                });
            }
            
            // 为批量计算按钮添加事件
            batchCalculateBtn.addEventListener('click', function() {
                if (!formula) {
                    alert('请先验证公式');
                    return;
                }
                
                if (variables.length === 0) {
                    alert('没有变量可计算');
                    return;
                }
                
                // 执行批量计算
                performBatchCalculation();
            });
            
            // 执行批量计算
            function performBatchCalculation() {
                // 显示结果区域
                batchResults.style.display = 'block';
                
                // 获取所有数据行
                const rows = variablesData.querySelectorAll('.variable-row');
                const rowsData = [];
                
                rows.forEach(row => {
                    const rowData = {};
                    
                    // 获取所有变量值
                    variables.forEach(variable => {
                        const input = row.querySelector(`input[data-variable="${variable}"]`);
                        const value = input ? parseFloat(input.value) : null;
                        rowData[variable] = isNaN(value) ? null : value;
                    });
                    
                    // 只添加至少有一个有效值的行
                    const hasValidValue = Object.values(rowData).some(value => value !== null);
                    if (hasValidValue) {
                        rowsData.push(rowData);
                    }
                });
                
                if (rowsData.length === 0) {
                    alert('没有有效的数据行');
                    return;
                }
                
                // 执行计算
                const results = [];
                let sum = 0;
                let validCount = 0;
                
                rowsData.forEach((rowData, index) => {
                    try {
                        // 检查是否所有必需的变量都有值
                        const missingVariables = variables.filter(v => rowData[v] === null || rowData[v] === undefined);
                        if (missingVariables.length > 0) {
                            results.push({
                                rowIndex: index + 1,
                                value: null,
                                error: `缺少变量: ${missingVariables.join(', ')}`
                            });
                            return;
                        }
                        
                        // 创建包含常量和变量的完整上下文
                        const context = { ...constants, ...rowData };
                        
                        // 使用math.js或自定义函数计算
                        const result = evaluateFormula(formula, context);
                        
                        if (!isNaN(result)) {
                            sum += result;
                            validCount++;
                            
                            results.push({
                                rowIndex: index + 1,
                                value: result,
                                error: null
                            });
                        } else {
                            results.push({
                                rowIndex: index + 1,
                                value: null,
                                error: '计算结果无效'
                            });
                        }
                    } catch (error) {
                        results.push({
                            rowIndex: index + 1,
                            value: null,
                            error: error.message
                        });
                    }
                });
                
                // 显示结果
                displayBatchResults(results, sum, validCount);
            }
            
            // 计算公式
            function evaluateFormula(formula, context) {
                try {
                    // 创建一个mathjs求值上下文
                    const mathScope = {};
                    
                    // 添加所有变量和常量到上下文
                    for (const [name, value] of Object.entries(context)) {
                        mathScope[name] = value;
                    }
                    
                    // 使用math.js安全地计算表达式
                    return math.evaluate(formula, mathScope);
                } catch (e) {
                    throw new Error('计算错误: ' + e.message);
                }
            }
            
            // 显示批量计算结果
            function displayBatchResults(results, sum, validCount) {
                batchResultsContainer.innerHTML = '';
                
                // 计算统计数据
                const mean = validCount > 0 ? sum / validCount : 0;
                
                // 计算标准差
                let sumSquaredDiff = 0;
                results.forEach(result => {
                    if (result.value !== null) {
                        sumSquaredDiff += Math.pow(result.value - mean, 2);
                    }
                });
                const variance = validCount > 1 ? sumSquaredDiff / (validCount - 1) : 0;
                const stdDev = Math.sqrt(variance);
                
                // 创建结果表格
                const table = document.createElement('table');
                table.className = 'results-table';
                
                // 表头
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                const headerIndex = document.createElement('th');
                headerIndex.textContent = '序号';
                headerRow.appendChild(headerIndex);
                
                const headerValue = document.createElement('th');
                headerValue.textContent = '计算结果';
                headerRow.appendChild(headerValue);
                
                const headerStatus = document.createElement('th');
                headerStatus.textContent = '状态';
                headerRow.appendChild(headerStatus);
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // 表体
                const tbody = document.createElement('tbody');
                
                results.forEach(result => {
                    const row = document.createElement('tr');
                    
                    const cellIndex = document.createElement('td');
                    cellIndex.textContent = result.rowIndex;
                    row.appendChild(cellIndex);
                    
                    const cellValue = document.createElement('td');
                    if (result.value !== null) {
                        cellValue.textContent = result.value.toFixed(6);
                    } else {
                        cellValue.textContent = '-';
                        cellValue.style.color = '#dc3545';
                    }
                    row.appendChild(cellValue);
                    
                    const cellStatus = document.createElement('td');
                    if (result.error) {
                        cellStatus.textContent = result.error;
                        cellStatus.style.color = '#dc3545';
                    } else {
                        cellStatus.textContent = '成功';
                        cellStatus.style.color = '#28a745';
                    }
                    row.appendChild(cellStatus);
                    
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                batchResultsContainer.appendChild(table);
                
                // 显示统计信息
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'results-summary';
                
                summaryDiv.innerHTML = `
                    <strong>统计信息：</strong><br>
                    有效数据数: ${validCount}<br>
                    平均值: ${mean.toFixed(6)}<br>
                    标准差: ${stdDev.toFixed(6)}<br>
                    不确定度(A类): ${(stdDev / Math.sqrt(validCount)).toFixed(6)}
                `;
                
                batchResultsContainer.appendChild(summaryDiv);
            }
        });
    </script>
</body>
</html>